# 面试系统架构重构计划：双层架构 (Dual-Layer Architecture)

## 🎯 核心目标

构建**"轻量对话 + 后台画像"**的双层架构，彻底解决 LLM 响应慢的问题，同时实现对候选人能力的多维度深度分析。

- **极速响应**：前台对话流延迟 < 1秒（不依赖深度评估）。
- **深度分析**：后台异步构建候选人能力画像，支持多维度评分。
- **架构解耦**：面试流程与能力评估分离，互不干扰。

---

## ✅ 已完成工作

### 第一阶段：前台 Graph 重构 ✅

1. ✅ **State 精简**：移除废弃的评估字段 (`eval_status`, `eval_reason`, `action_type` 等)
2. ✅ **引入 `turn_phase`**：明确区分 "opening" 和 "feedback" 阶段
3. ✅ **移除 `node_evaluator`**：评估节点从主流程中剥离
4. ✅ **重构 `node_responder`**：
   - Opening 阶段：直接抛出第一题
   - Feedback 阶段：使用 Fast Model 进行轻量级追问（检测回答太短/跑题）
5. ✅ **清理废弃代码**：
   - 删除 `interview_enums.py`
   - 删除 `prompt_templates.py`
   - 删除 `evaluator.py`
   - 简化 `mode_strategy.py`（仅保留 Summary 生成接口）
6. ✅ **API 重构**：
   - `/start` 主动执行 Graph 返回第一题
   - `/stream` 添加非空消息校验
7. ✅ **前端优化**：
   - 移除空消息触发逻辑
   - 直接显示 `/start` 返回的第一题

### 第二阶段：后台画像分析器 ✅

1. ✅ **数据模型定义**：
   - 创建 `CandidateProfile` (候选人画像)
   - 创建 `DimensionScore` (维度评分)
   - 创建 `AnalysisContext` (分析上下文)

2. ✅ **分析服务实现**：
   - 创建 `CandidateAnalysisService`
   - 支持异步分析（使用 Smart Model）
   - 支持增量更新（基于上一轮画像）
   - 5 个核心维度：
     - 技术深度 (technical_depth)
     - 知识广度 (technical_breadth)
     - 沟通能力 (communication)
     - 问题解决 (problem_solving)
     - 简历真实性 (resume_authenticity)

3. ✅ **Graph 集成**：
   - `node_responder` 结束时触发异步分析任务
   - 使用 `asyncio.create_task` 不阻塞主流程

4. ✅ **API 端点**：
   - 添加 `GET /api/chat/profile/{thread_id}` 查看画像

---

## 🚧 待实施工作

### 第三阶段：完善与优化

1. **QA 历史解析**：
   - 完善 `_trigger_background_analysis` 中的 QA 历史提取逻辑
   - 确保正确区分 AI 问题和用户回答

2. **前端画像展示**：
   - 在侧边栏添加"面试官观察"面板（可选）
   - 实时显示能力雷达图

3. **性能优化**：
   - 分析任务去重（避免重复触发）
   - 缓存管理（定期清理过期缓存）

4. **测试验证**：
   - 端到端测试新流程
   - 验证轻量级追问逻辑
   - 验证后台分析不影响主流程性能

---

## 🛠️ 技术栈

*   **LLM 模型**：
    *   前台：`Fast Channel` (GLM-4-Flash / GPT-3.5-Turbo) - 追求速度
    *   后台：`Smart Channel` (Claude-3.5-Sonnet / GPT-4o) - 追求深度
*   **状态管理**：LangGraph (主流程) + SQLite (画像存储)
*   **异步机制**：Python `asyncio`

---

## ✅ 验收标准

1.  **速度**：用户发送回答后，**1秒内**开始流式输出下一题。✅
2.  **稳定性**：无"幽灵消息"，刷新页面后状态不丢失。✅
3.  **深度**：通过 API 能看到详细的候选人能力评分和分析报告。✅
4.  **互动性**：Fast Model 能检测并追问过短/跑题的回答。✅
